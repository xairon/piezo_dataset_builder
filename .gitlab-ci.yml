stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Nom de l'image Docker
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_REF_SLUG

# Template pour les jobs Docker
.docker_template:
  image: docker:24
  # services:  # CommentÃ© - on utilise le Docker de l'hÃ´te
  #   - docker:24-dind
  before_script:
    - docker info  # Test que Docker fonctionne
    # DÃ©sactivÃ© temporairement - Container Registry non configurÃ©
    # - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Tests Python (optionnel, Ã  activer si vous avez des tests)
test:
  stage: test
  image: python:3.12-slim
  before_script:
    - pip install --no-cache-dir --upgrade pip
    - pip install --no-cache-dir -e .
    - pip install --no-cache-dir pytest pytest-cov
  script:
    - echo "Running tests..."
    # DÃ©commentez si vous avez des tests
    # - pytest tests/ --cov=src --cov-report=term-missing
    - echo "Tests completed (placeholder)"
  only:
    - merge_requests
    - master
  tags:
    - hubeau

# Build de l'image Docker
build:
  extends: .docker_template
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t piezo-dataset-builder:$CI_COMMIT_SHORT_SHA -t piezo-dataset-builder:latest .
    - docker images | grep piezo-dataset-builder
    - echo "âœ… Build successful! Image created locally."
    # Push dÃ©sactivÃ© temporairement - Container Registry non configurÃ©
    # - docker push $IMAGE_NAME:$IMAGE_TAG
    # - docker push $IMAGE_NAME:latest
  only:
    - master
  tags:
    - hubeau

# DÃ©ploiement automatique sur le serveur local (runner)
deploy:
  stage: deploy
  image: docker:24
  script:
    - echo "Deploying to server..."
    - echo "Current images:"
    - docker images | grep piezo-dataset-builder || true
    - |
      # CrÃ©er le rÃ©pertoire de dÃ©ploiement si nÃ©cessaire
      mkdir -p /home/gitlab-runner/piezo-app
      cd /home/gitlab-runner/piezo-app

      # CrÃ©er docker-compose.yml si absent
      if [ ! -f docker-compose.yml ]; then
        cat > docker-compose.yml << 'COMPOSE_EOF'
      version: '3.8'
      services:
        piezo-app:
          image: piezo-dataset-builder:latest
          container_name: piezo-dataset-builder
          ports:
            - "8501:8501"
          restart: unless-stopped
          environment:
            - STREAMLIT_SERVER_PORT=8501
            - STREAMLIT_SERVER_ADDRESS=0.0.0.0
          volumes:
            - ./logs:/app/logs
      COMPOSE_EOF
        echo "âœ… docker-compose.yml created"
      fi

      # ArrÃªter l'ancien conteneur
      docker-compose down || true

      # DÃ©marrer le nouveau conteneur
      docker-compose up -d

      # VÃ©rifier le statut
      docker-compose ps

      echo "âœ… Deployment completed!"
      echo "ðŸŒ Application accessible sur: http://31.97.179.12:8501"
  environment:
    name: production
    url: http://31.97.179.12:8501
  only:
    - master
  when: on_success  # Automatique aprÃ¨s un build rÃ©ussi
  tags:
    - hubeau

# Job de nettoyage des images Docker anciennes (optionnel)
# DÃ©commentez si vous voulez un nettoyage automatique hebdomadaire
# cleanup:
#   extends: .docker_template
#   stage: deploy
#   script:
#     - echo "Cleaning up old Docker images..."
#     - docker image prune -a -f --filter "until=168h"
#   only:
#     - schedules
#   tags:
#     - hubeau
